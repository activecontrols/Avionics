#include <Arduino.h>
#include "dshot_api.h"

void readTlm() {
    int8_t temperature;
    uint8_t volt_high, volt_low, curr_high, curr_low, consump_high, consump_low, eRPM_h, eRPM_l, crc_8;
  noInterrupts();
  if (isTlmAvailable()) {
    resetTlmFlag();
    interrupts();
    static uint8_t bufferTlm[TLM_LENGTH];
    while (Serial1.available() < TLM_LENGTH);

    for (int i = 0; i < TLM_LENGTH; i++) {
      bufferTlm[i] = Serial1.read();
    }
    tlmData.temperature = bufferTlm[0];
    tlmData.volt_high = (bufferTlm[1] << 8);
    tlmData.volt_low= bufferTlm[2];
    tlmData.curr_high = (bufferTlm[3] << 8) ;
    tlmData.curr_low= bufferTlm[4];
    tlmData.consump_high= (bufferTlm[5] << 8);
    tlmData.consump_low= bufferTlm[6];
    tlmData.eRPM_h = (bufferTlm[7] << 8);
    tlmData.eRPM_l=bufferTlm[8];
    tlmData.crc_8 = (bufferTlm[9] == calculateCrc8(bufferTlm, TLM_LENGTH-1));
    if(tlmData.crc8)
    {}
    else{}
}
else{
    interrupts();
}
